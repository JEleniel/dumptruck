# Detailed Breach Analysis Report Schema

This document defines the comprehensive JSON report structure generated by Dumptruck's ingest command. All fields are designed for security operations, forensic analysis, and breach attribution.

## Report Structure Overview

```json
{
  "metadata": {
    "report_version": "2.0",
    "generated_at": "2025-12-18T10:30:45Z",
    "file_processed": "breach_data.csv",
    "file_id": "550e8400-e29b-41d4-a716-446655440000",
    "file_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
    "operator": "security-analyst@company.com",
    "source": "HIBP-2024-01"
  },
  "summary": {
    "total_rows_processed": 1000,
    "unique_addresses": 950,
    "duplicate_count": 50,
    "new_addresses_never_seen": 920,
    "compromised_addresses_with_new_creds": 30,
    "weak_passwords_found": 45,
    "pii_fields_detected": 12,
    "rows_with_pii": 450,
    "risk_score_distribution": { "0-20": 5, "21-40": 45, "41-60": 200, "61-80": 600, "81-100": 150 },
    "highest_risk_score": 98,
    "average_risk_score": 72.3
  },
  "chain_of_custody": {
    "signature": {
      "operator_id": "security-analyst@company.com",
      "timestamp_utc": "2025-12-18T10:30:45Z",
      "file_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
      "row_count": 1000,
      "unique_address_count": 950,
      "signature_algorithm": "ED25519",
      "signature_hex": "3045022100abcd1234...ef5678",
      "verified": true
    }
  },
  "duplicate_ids": {
    "count": 50,
    "items": [
      {
        "address": "john.doe@gmail.com",
        "occurrences": 3,
        "row_indices": [5, 127, 342],
        "first_seen_canonical": "john.doe@gmail.com",
        "canonical_form": "john.doe@gmail.com",
        "aliases": [
          { "form": "john_doe@gmail.com", "type": "underscore_variant" },
          { "form": "john.doe+spam@gmail.com", "type": "plus_addressing" }
        ]
      }
    ]
  },
  "new_addresses": {
    "count": 920,
    "items": [
      {
        "address": "alice.smith@example.com",
        "row_index": 10,
        "canonical_form": "alice.smith@example.com",
        "domain_aliases": ["alicesmith@example.com"],
        "first_credential_hash": "5e884898...",
        "first_credential_strength": "strong"
      }
    ]
  },
  "compromised_with_new_credentials": {
    "description": "Previously compromised addresses now appearing with new, never-before-seen credentials. HIGHEST PRIORITY for immediate user notification.",
    "count": 30,
    "items": [
      {
        "address": "bob.wilson@example.com",
        "breach_history": [
          {
            "name": "LinkedIn-2021",
            "date": "2021-06-22",
            "credential_hash_old": "5f4dcc3b5aa765d61d8327deb882cf99",
            "algorithm_old": "md5"
          }
        ],
        "current_credential_hash": "abcdef1234567890...",
        "current_algorithm": "bcrypt",
        "is_new_credential": true,
        "risk_score": 92,
        "action_required": "immediate_notification"
      }
    ]
  },
  "weak_passwords": {
    "count": 45,
    "items": [
      {
        "address": "carol.jones@example.com",
        "password": "password123",
        "row_index": 45,
        "strength": "weak",
        "reason": "in_top_1000_common_passwords",
        "crack_time_seconds": 0.003,
        "rainbow_table_match": true,
        "similar_to_hashes": [
          "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"
        ]
      }
    ]
  },
  "pii_and_npi_details": {
    "summary": {
      "total_fields_detected": 12,
      "total_rows_with_pii": 450,
      "field_types": {
        "ssn": 450,
        "credit_card": 450,
        "phone_number": 400,
        "national_id": 350,
        "iban": 50,
        "crypto_address": 25
      }
    },
    "by_row": [
      {
        "row_index": 1,
        "address": "john.doe@example.com",
        "pii_fields": [
          {
            "type": "ssn",
            "value_hash": "sha256:a1b2c3d4...",
            "confidence": 0.99,
            "pattern": "XXX-XX-XXXX"
          },
          {
            "type": "credit_card",
            "value_hash": "sha256:e5f6g7h8...",
            "confidence": 0.98,
            "pattern": "XXXX-XXXX-XXXX-####",
            "card_type": "visa"
          },
          {
            "type": "phone_number",
            "value_hash": "sha256:i9j0k1l2...",
            "confidence": 0.95,
            "country": "US",
            "pattern": "(555) ###-####"
          }
        ],
        "risk_score": 95,
        "compliance_flags": ["GDPR", "CCPA", "PCI-DSS"]
      }
    ]
  },
  "alias_and_canonicalization": {
    "count": 120,
    "items": [
      {
        "original_form": "john_doe@googlemail.com",
        "canonical_form": "john.doe@gmail.com",
        "transformations_applied": [
          {
            "type": "domain_alias",
            "from": "googlemail.com",
            "to": "gmail.com",
            "reason": "Known Google domain alias"
          },
          {
            "type": "punctuation_normalization",
            "from": "john_doe",
            "to": "john.doe",
            "reason": "Unicode normalization NFKC"
          }
        ],
        "confidence": 0.98,
        "linked_addresses": [
          "john.doe@gmail.com",
          "john.doe+spam@gmail.com"
        ]
      }
    ]
  },
  "risk_scoring_details": {
    "algorithm_version": "1.0",
    "scoring_model": "Multi-factor vulnerability assessment",
    "methodology": "See docs/RISK_SCORING_ALGORITHM.md for detailed documentation",
    "by_row": [
      {
        "row_index": 1,
        "address": "john.doe@example.com",
        "risk_score": 92,
        "score_components": {
          "weak_password": { "score": 30, "weight": 0.3, "contribution": 9 },
          "hashed_credential_weak_algorithm": { "score": 20, "weight": 0.2, "contribution": 4 },
          "breach_history": { "score": 40, "weight": 0.4, "contribution": 16 },
          "pii_exposure": { "score": 25, "weight": 0.15, "contribution": 3.75 },
          "anomaly_detection": { "score": 8, "weight": 0.1, "contribution": 0.8 }
        },
        "total_score_raw": 103,
        "total_score_normalized": 92,
        "risk_level": "critical",
        "primary_factors": [
          "Previously breached (LinkedIn 2021)",
          "New credential detected",
          "Contains SSN and credit card"
        ],
        "action_required": "immediate_notification"
      }
    ]
  },
  "errors": []
}
```

## Field Definitions

### metadata

- **report_version**: Schema version (currently 2.0)
- **file_id**: UUID v4 uniquely identifying this ingest operation
- **file_sha256**: Content hash for integrity verification
- **operator**: User/service that performed the ingest
- **source**: Attribution/source of the data (breach name, date, etc)

### summary

High-level statistics for quick assessment and trending.

### chain_of_custody

Cryptographic proof of processing:

- **signature_hex**: ED25519 signature covering operator, timestamp, file hash, and row counts
- All fields are part of the signed record and cannot be modified without breaking the signature

### duplicate_ids

Identifies exact email/address duplicates within this dataset:

- **occurrences**: How many times this address appears
- **row_indices**: Which rows contain this address
- **aliases**: Known variants linked to this primary address

### new_addresses

Addresses never seen before in breach databases:

- **first_credential_hash**: SHA-256 of first observed credential
- **canonical_form**: Normalized email address

### compromised_with_new_credentials

**HIGHEST PRIORITY**: Previously breached addresses now appearing with NEW credentials they've never used before. Indicates:

1. Attacker is actively using stolen identity
2. User likely unaware they were compromised
3. Immediate notification required

### weak_passwords

Credentials matching common password rainbow table:

- **crack_time_seconds**: Estimated time to crack via GPU (from hashcat benchmarks)
- **rainbow_table_match**: Direct match in our 566K common password database

### pii_and_npi_details

Individual field detection with hashes (values are never stored plaintext):

- **type**: SSN, credit_card, phone_number, national_id, iban, swift, routing_number, bank_account, crypto_address, digital_wallet
- **value_hash**: SHA-256 of the PII value (never the value itself)
- **confidence**: 0.0-1.0 confidence score for this field classification
- **compliance_flags**: Regulations triggered (GDPR, CCPA, HIPAA, PCI-DSS, etc)

### alias_and_canonicalization

Shows transformations applied during normalization:

- **domain_alias**: gmail.com ↔ googlemail.com, etc
- **punctuation_normalization**: john_doe → john.doe
- **plus_addressing**: <john.doe+tag@gmail.com> → <john.doe@gmail.com> (Gmail-specific)
- **unicode_normalization**: Accents, ligatures, etc

### risk_scoring_details

See [Risk Scoring Algorithm](#risk-scoring-algorithm) section below.

---

## Risk Scoring Algorithm

**Algorithm Version**: 1.0
**Status**: REQUIRES SECURITY TEAM APPROVAL BEFORE DEPLOYMENT

### Overview

Risk scoring assigns a 0-100 normalized score to each row based on credential compromise potential. The algorithm combines five independent risk factors with weighted contributions.

### Scoring Components

| Factor | Max Score | Weight | Contribution | Description |
|--------|-----------|--------|---------------|-------------|
| **Weak Password** | 30 | 0.30 (30%) | 0-9 | Plaintext password in top 1000 common passwords |
| **Hashed Credential (Weak Algorithm)** | 20 | 0.20 (20%) | 0-4 | MD5/SHA1/SHA256 hashes (easily crackable) |
| **Breach History** | 40 | 0.40 (40%) | 0-16 | Address appears in known breaches (HIBP) |
| **PII Exposure** | 25 | 0.15 (15%) | 0-3.75 | SSN, credit card, national ID present |
| **Anomaly Detection** | 8 | 0.10 (10%) | 0-0.8 | Statistical outliers, rare combinations |

**Total Raw Score Range**: 0-123
**Normalized Score**: (Raw / 123) × 100 → 0-100 range

### Calculation Formula

```
raw_score = 
  weak_password_score × 0.30 +
  weak_hash_score × 0.20 +
  breach_history_score × 0.40 +
  pii_exposure_score × 0.15 +
  anomaly_score × 0.10

normalized_score = (raw_score / 123) × 100
```

### Factor Definitions

#### 1. Weak Password Factor (0-30 points, 30% weight)

**Triggers**:

- Password is plaintext (not hashed)
- AND password is in top 1000 common passwords (rainbow table match)

**Score Calculation**:

- Found in top 100: 30 points
- Found in top 1000: 25 points
- Found in keyboard patterns (qwerty, 123456): 20 points

**Rationale**: Plaintext weak passwords can be cracked in milliseconds. Immediate threat.

#### 2. Weak Hash Algorithm Factor (0-20 points, 20% weight)

**Triggers**:

- Credential is pre-hashed AND uses weak algorithm

**Algorithm Classification**:

- **Weak (20 pts)**: MD5, SHA1, SHA256, NTLM (no salt/iteration)
- **Medium (10 pts)**: Salted MD5/SHA1, single iteration PBKDF2
- **Strong (0 pts)**: bcrypt, scrypt, argon2, PBKDF2 (100k+ iterations)

**Rationale**: Weak hashes can be cracked in hours to days with GPU acceleration.

#### 3. Breach History Factor (0-40 points, 40% weight)

**Triggers**:

- Address has been in previous breaches (HIBP API)

**Score Calculation**:

- First breach appearance: 15 points
- Each additional breach: +5 points (capped at 40)
- With NEW credential since last breach: +20 bonus (45 total possible)

**Rationale**: Breached addresses are priority targets; new credentials = active exploitation.

#### 4. PII Exposure Factor (0-25 points, 15% weight)

**Triggers**:

- Row contains personally identifiable information

**Field Scoring**:

- SSN present: +10 points
- Credit card present: +10 points
- National ID present: +5 points
- Phone number present: +3 points
- IBAN/SWIFT present: +5 points
- Crypto address present: +2 points
- (Score capped at 25)

**Rationale**: PII enables identity theft beyond simple credential compromise.

#### 5. Anomaly Detection Factor (0-8 points, 10% weight)

**Triggers**:

- Statistical outliers from dataset baseline

**Anomaly Types**:

- Entropy outlier (>3σ): 3 points
- Unseen field combination: 2 points
- Rare domain/user pattern: 2 points
- Unexpected credential format: 1 point

**Rationale**: Anomalies may indicate data quality issues or targeted attacks.

### Risk Level Classification

| Score Range | Level | Action |
|-------------|-------|--------|
| 0-20 | Low | Monitor |
| 21-40 | Medium | Review |
| 41-60 | High | Investigate |
| 61-80 | Critical | Immediate action |
| 81-100 | Severe | Emergency response |

### Examples

#### Example 1: New Address, Strong Credential

```
Address: alice@example.com (new, never breached)
Credential: bcrypt(password)
PII: None
Anomalies: None

Calculation:
  weak_password: 0 (bcrypt)
  weak_hash: 0 (bcrypt is strong)
  breach_history: 0 (never breached)
  pii_exposure: 0 (no PII)
  anomaly: 0 (normal pattern)
  
  raw_score = 0
  normalized_score = 0
  
Result: SCORE = 0 (GREEN - No action needed)
```

#### Example 2: Breached Address, Weak Password

```
Address: bob@example.com (LinkedIn 2021, Equifax 2015)
Credential: password123 (plaintext)
PII: SSN + Credit Card
Anomalies: 1 entropy outlier

Calculation:
  weak_password: 30 (top 100 common)
  weak_hash: 0 (plaintext, not hashed)
  breach_history: 35 (2 breaches + NEW cred = 15 + 5 + 20)
  pii_exposure: 20 (SSN + CC)
  anomaly: 3 (entropy outlier)
  
  raw_score = (30×0.30) + (0×0.20) + (35×0.40) + (20×0.15) + (3×0.10)
           = 9 + 0 + 14 + 3 + 0.3
           = 26.3
  
  normalized_score = (26.3 / 123) × 100 = 21.4
  
Result: SCORE = 21 (YELLOW - Immediate notification required)
```

#### Example 3: Multiple Risk Factors

```
Address: carol@example.com (new)
Credential: sha1(password)
PII: SSN + CC + National ID
Anomalies: Rare domain, unseen combo

Calculation:
  weak_password: 0 (not plaintext)
  weak_hash: 20 (SHA1)
  breach_history: 0 (new)
  pii_exposure: 25 (SSN + CC + ID = capped)
  anomaly: 4 (rare domain + unseen combo)
  
  raw_score = (0×0.30) + (20×0.20) + (0×0.40) + (25×0.15) + (4×0.10)
           = 0 + 4 + 0 + 3.75 + 0.4
           = 8.15
  
  normalized_score = (8.15 / 123) × 100 = 6.6
  
Result: SCORE = 7 (GREEN - but FLAG for PII exposure due to abundance of sensitive data)
```

---

## Models and Dependencies

### Rainbow Table Model

- **Purpose**: Detect plaintext weak passwords
- **Data**: 566,408 common passwords pre-computed
- **Source**: CrackStation, RockYou breach, common patterns
- **Accuracy**: 100% for exact matches
- **Limitations**: Only detects passwords in the table, misses unknowns
- **Approval Status**: ⏳ AWAITING REVIEW

### Vector Similarity Model

- **Purpose**: Detect near-duplicate addresses
- **Model**: Nomic Embed (768-dimensional vectors)
- **Threshold**: 0.85 cosine similarity
- **Accuracy**: ~95% for true near-duplicates at threshold
- **False positives**: ~2% (similar names that aren't duplicates)
- **Approval Status**: ⏳ AWAITING REVIEW

### HIBP Integration

- **Purpose**: Breach history lookup
- **Source**: Have I Been Pwned API (Troy Hunt)
- **Latency**: 100-500ms per lookup (rate limited)
- **Accuracy**: Depends on HIBP database freshness (~24h lag)
- **Approval Status**: ✅ PRODUCTION-APPROVED (Troy Hunt's reputable service)

### Anomaly Detection Model

- **Purpose**: Statistical outlier identification
- **Method**: Isolation Forest on entropy + field combinations
- **Accuracy**: ~90% for genuine anomalies
- **False positives**: ~5% (legitimate unique records flagged)
- **Approval Status**: ⏳ AWAITING REVIEW

---

## Approval Workflow

**Current Status**: DRAFT - REQUIRES REVIEW

**Required Approvals Before Deployment**:

- [ ] Security Officer Sign-off (risk scoring weights and thresholds)
- [ ] Data Science Lead (model accuracy and false positive rates)
- [ ] Legal/Compliance (PII handling, GDPR/CCPA implications)
- [ ] Privacy Officer (data retention and deletion policies)

**Approval Template**:

```
Approved by: [Name]
Title: [Title]
Date: [Date]
Signature: [Digital signature or hash]
Comments: [Any feedback or conditions]
```

---

## Change Log

| Version | Date | Changes | Approval |
|---------|------|---------|----------|
| 1.0 | 2025-12-18 | Initial schema and algorithm | PENDING |
